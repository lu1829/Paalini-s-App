const STORAGE_KEY = 'codebookLayout_v2';
const DEFAULT_BOARD_HTML = document.getElementById('board').innerHTML;

function normalize(s) {
  return (s || '').trim().toLowerCase();
}

function saveBoard() {
  localStorage.setItem(STORAGE_KEY, document.getElementById('board').innerHTML);
}

function updateCounts() {
  document.querySelectorAll('.column').forEach(col => {
    const count = col.querySelectorAll('.card').length;
    const counter = col.querySelector('.card-count');
    if (counter) counter.innerText = count;
  });
}

// --- Quote count badge injection (no need to edit all cards) ---
function ensureQuoteBadge(card) {
  const typeEl = card.querySelector('.card-type');
  if (!typeEl) return;

  let badge = typeEl.querySelector('.quote-count');
  if (!badge) {
    badge = document.createElement('span');
    badge.className = 'quote-count';
    typeEl.appendChild(badge);
  }

  const n = Number(card.dataset.quoteCount || 0);
  badge.textContent = `${n} quote${n === 1 ? '' : 's'}`;
}

function inferQuoteCountFromRenderedQuotes(text) {
  const t = (text || '').trim();
  if (!t) return 0;
  const chunks = t.split(/\n\s*\n/).map(x => x.trim()).filter(Boolean);
  return chunks.length || 1;
}

function refreshAllBadges() {
  document.querySelectorAll('.card').forEach(card => {
    if (!card.dataset.quoteCount) {
      const quoteEl = card.querySelector('.card-quote');
      const n = (quoteEl && quoteEl.classList.contains('visible'))
        ? inferQuoteCountFromRenderedQuotes(quoteEl.innerText)
        : 0;
      card.dataset.quoteCount = String(n);
    }
    ensureQuoteBadge(card);
  });
}

function initSortable() {
  document.querySelectorAll('.card-list').forEach(column => {
    new Sortable(column, {
      group: 'shared',
      animation: 150,
      ghostClass: 'sortable-ghost',
      onEnd: () => { updateCounts(); saveBoard(); }
    });
  });
}

// --- CSV hydration: supports multiple rows with same tag ---
function hydrateCards(rows) {
  const map = new Map(); // tag -> [quotes]
  (rows || []).forEach(r => {
    const tag = normalize(r.tag);
    const content = (r.content || '').trim();
    if (!tag || !content) return;
    if (!map.has(tag)) map.set(tag, []);
    map.get(tag).push(content);
  });

  let matchedTotal = 0;

  document.querySelectorAll('.card').forEach(card => {
    const titleEl = card.querySelector('.card-text');
    const quoteEl = card.querySelector('.card-quote');
    if (!titleEl || !quoteEl) return;

    const key = normalize(titleEl.innerText);
    const quotes = map.get(key);

    if (quotes && quotes.length) {
      quoteEl.innerText = quotes.map(q => `“${q}”`).join('\n\n');
      quoteEl.classList.add('visible');
      card.dataset.quoteCount = String(quotes.length);
      matchedTotal += quotes.length;
    } else {
      // keep existing content, but ensure count is consistent
      const existing = quoteEl.classList.contains('visible') ? quoteEl.innerText : '';
      card.dataset.quoteCount = String(inferQuoteCountFromRenderedQuotes(existing));
    }

    ensureQuoteBadge(card);
  });

  updateCounts();
  saveBoard();
  alert(`CSV imported: matched ${matchedTotal} quotes across your codes.`);
}

// --- Wire up controls ---
const csvInput = document.getElementById('csvInput');
document.getElementById('importBtn').addEventListener('click', () => csvInput.click());

csvInput.addEventListener('change', (e) => {
  const file = e.target.files?.[0];
  if (!file) return;

  Papa.parse(file, {
    header: true,
    skipEmptyLines: true,
    complete: (results) => {
      hydrateCards(results.data || []);
      csvInput.value = '';
    }
  });
});

document.getElementById('addCodeBtn').addEventListener('click', () => {
  const title = prompt("Enter the code name:");
  if (!title) return;

  const newCard = document.createElement('div');
  newCard.className = 'card';
  newCard.dataset.quoteCount = "0";
  newCard.innerHTML = `
    <div class="card-text">${title}</div>
    <div class="card-type">code</div>
    <div class="card-quote"></div>
  `;

  const firstList = document.querySelector('.card-list');
  if (firstList) firstList.prepend(newCard);

  ensureQuoteBadge(newCard);
  updateCounts();
  saveBoard();
});

document.getElementById('saveBtn').addEventListener('click', () => {
  saveBoard();
  const btn = document.getElementById('saveBtn');
  const original = btn.innerText;
  btn.innerText = "Saved!";
  setTimeout(() => btn.innerText = original, 1000);
});

document.getElementById('resetBtn').addEventListener('click', () => {
  localStorage.removeItem(STORAGE_KEY);
  document.getElementById('board').innerHTML = DEFAULT_BOARD_HTML;

  initSortable();
  updateCounts();
  refreshAllBadges();
  saveBoard();
});

window.addEventListener('load', () => {
  const saved = localStorage.getItem(STORAGE_KEY);

  // If a saved layout exists, restore it; otherwise keep the default HTML in the file
  if (saved) {
    document.getElementById('board').innerHTML = saved;
  }

  initSortable();
  updateCounts();
  refreshAllBadges();
});
